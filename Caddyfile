# Apex domain redirect: yourapp.com -> app.yourapp.com
# Only active when APEX_DOMAIN is set in .env
{$APEX_DOMAIN} {
	redir https://{$FRONTEND_DOMAIN}{uri} permanent
}

# Frontend: app subdomain (e.g. app.yourapp.com)
# Set FRONTEND_DOMAIN in .env for production
{$FRONTEND_DOMAIN} {
	reverse_proxy frontend:3000
}

# API: set API_DOMAIN in .env (e.g. api.yourapp.com or localhost for local)
# read_timeout 600s keeps long-lived SSE connections (e.g. /workflow/status/{run_id}/stream) open
{$API_DOMAIN} {
	reverse_proxy api:8000 {
		transport http {
			read_timeout 600s
		}
	}
}

# Optional: to expose Flower, add the block below and set FLOWER_DOMAIN (and Basic Auth vars) in .env.
# Generate hash: caddy hash-password  or  htpasswd -nbB user password
# In .env escape bcrypt hash: use $$ for each $ (e.g. $$2y$$05$$...)

# {$FLOWER_DOMAIN} {
# 	basic_auth * {
# 		{$FLOWER_BASIC_AUTH_USER} {$FLOWER_BASIC_AUTH_HASH}
# 	}
# 	reverse_proxy flower:5555
# }

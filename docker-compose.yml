

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: job-agent-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - job-agent-network

  # Redis Message Broker
  redis:
    image: redis:7-alpine
    container_name: job-agent-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - job-agent-network

  # FastAPI Application (with hot reload for development)
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-job_agent}
      # Redis
      REDIS_URL: redis://redis:6379/0
      # Celery
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # API Keys (set in .env)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      NYLAS_API_KEY: ${NYLAS_API_KEY:-}
      NYLAS_API_URI: ${NYLAS_API_URI:-https://api.nylas.com}
      NYLAS_GRANT_ID: ${NYLAS_GRANT_ID:-}
      PDFBOLTS_API_KEY: ${PDFBOLTS_API_KEY:-}
      # Sentry / env (Phase 7+)
      SENTRY_DSN: ${SENTRY_DSN:-}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      RELEASE_VERSION: ${RELEASE_VERSION:-1.0.0}
      # Other environment variables
      PYTHONPATH: /app
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./test:/app/test
      - ./docs:/app/docs
      - ./pyproject.toml:/app/pyproject.toml
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - job-agent-network
    command: ["uvicorn","src.api.api:app","--host","0.0.0.0","--port","8000","--reload","--reload-dir","/app/src"]

  # Celery Worker (will be configured in Phase 2)
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-celery-worker
    restart: unless-stopped
    environment:
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-job_agent}
      # Redis
      REDIS_URL: redis://redis:6379/0
      # Celery
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # API Keys (set in .env)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      NYLAS_API_KEY: ${NYLAS_API_KEY:-}
      NYLAS_API_URI: ${NYLAS_API_URI:-https://api.nylas.com}
      NYLAS_GRANT_ID: ${NYLAS_GRANT_ID:-}
      PDFBOLTS_API_KEY: ${PDFBOLTS_API_KEY:-}
      # Sentry / env (Phase 7+)
      SENTRY_DSN: ${SENTRY_DSN:-}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      RELEASE_VERSION: ${RELEASE_VERSION:-1.0.0}
      PYTHONPATH: /app
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./test:/app/test
      - ./pyproject.toml:/app/pyproject.toml
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    networks:
      - job-agent-network
    command: >
      sh -c "
        celery -A src.celery_app worker 
        --loglevel=info 
        --concurrency=2
        --queues=high_priority,default
        --reload
      "

  # Flower - Celery Monitoring (will work after Phase 2)
  flower:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-flower
    restart: unless-stopped
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      PYTHONPATH: /app
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_started
    networks:
      - job-agent-network
    command: >
      sh -c "
        celery -A src.celery_app flower 
        --port=5555 
        --broker=redis://redis:6379/0
      "

volumes:
  postgres_data:
  redis_data:

networks:
  job-agent-network:
    driver: bridge
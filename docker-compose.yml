

services:
  # PostgreSQL Database
  # Bootstrap user is always postgres; init script creates job_agent_admin and job_agent_ui.
  postgres:
    image: postgres:16-alpine
    container_name: job-agent-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_INIT_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
      POSTGRES_ADMIN_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_UI_PASSWORD: ${POSTGRES_UI_PASSWORD:-changeme}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db-users.sh:/docker-entrypoint-initdb.d/init-db-users.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - job-agent-network

  # Redis Message Broker
  redis:
    image: redis:7-alpine
    container_name: job-agent-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - job-agent-network

  # FastAPI Application (with hot reload for development)
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-job_agent}
      # Redis
      REDIS_URL: redis://redis:6379/0
      # Celery
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # API Keys (set in .env)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      NYLAS_API_KEY: ${NYLAS_API_KEY:-}
      NYLAS_API_URI: ${NYLAS_API_URI:-https://api.nylas.com}
      NYLAS_GRANT_ID: ${NYLAS_GRANT_ID:-}
      PDFBOLTS_API_KEY: ${PDFBOLTS_API_KEY:-}
      # Langfuse (api uses workflows/LLM when triggering tasks)
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL:-https://us.cloud.langfuse.com}
      # Sentry / env (Phase 7+)
      SENTRY_DSN: ${SENTRY_DSN:-}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      RELEASE_VERSION: ${RELEASE_VERSION:-1.0.0}
      # API authentication
      JOB_LAND_API_KEY: ${JOB_LAND_API_KEY:-}
      # Other environment variables
      PYTHONPATH: /app
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./test:/app/test
      - ./docs:/app/docs
      - ./pyproject.toml:/app/pyproject.toml
      # Mount alembic so setup.sh / migrations see latest versions (e.g. 002)
      - ./alembic:/app/alembic
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - job-agent-network
    command: ["uvicorn","src.api.api:app","--host","0.0.0.0","--port","8000","--reload","--reload-dir","/app/src"]

  # Celery Worker
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-celery-worker
    restart: unless-stopped
    healthcheck:
      # Wait for worker to respond to inspect (worker loads onnxruntime etc. so give long start_period)
      test: ["CMD-SHELL", "celery -A src.celery_app inspect ping || exit 1"]
      interval: 15s
      timeout: 10s
      start_period: 90s
      retries: 5
    environment:
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-job_agent}
      DATABASE_URL: postgresql+psycopg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-job_agent}
      # Redis
      REDIS_URL: redis://redis:6379/0
      # Celery
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # API Keys (set in .env)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      SERPAPI_KEY: ${SERPAPI_KEY:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      NYLAS_API_KEY: ${NYLAS_API_KEY:-}
      NYLAS_API_URI: ${NYLAS_API_URI:-https://api.nylas.com}
      NYLAS_GRANT_ID: ${NYLAS_GRANT_ID:-}
      PDFBOLTS_API_KEY: ${PDFBOLTS_API_KEY:-}
      # Langfuse (celery-worker runs workflows/LLM)
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL:-https://us.cloud.langfuse.com}
      # Sentry / env (Phase 7+)
      SENTRY_DSN: ${SENTRY_DSN:-}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      RELEASE_VERSION: ${RELEASE_VERSION:-1.0.0}
      PYTHONPATH: /app
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./test:/app/test
      - ./pyproject.toml:/app/pyproject.toml
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    networks:
      - job-agent-network
    command: >
      sh -c "
        celery -A src.celery_app worker 
        --loglevel=info 
        --concurrency=2
        --queues=high_priority,default
        --reload
      "

  # Flower - Celery Monitoring (starts after worker is healthy so inspect methods work)
  flower:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: job-agent-flower
    restart: unless-stopped
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    environment:
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      PYTHONPATH: /app
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    networks:
      - job-agent-network
    command: >
      sh -c "
        celery -A src.celery_app flower
        --port=5555
        --broker=redis://redis:6379/0
        --result_backend=redis://redis:6379/0
      "

  # Next.js Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: job-agent-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    environment:
      NODE_ENV: production
      # Database (limited privilege user)
      DATABASE_URL: postgresql://job_agent_ui:${POSTGRES_UI_PASSWORD}@postgres:5432/${POSTGRES_DB:-job_agent}
      # Better Auth
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
      NEXT_PUBLIC_BETTER_AUTH_URL: ${NEXT_PUBLIC_BETTER_AUTH_URL:-http://localhost:3000}
      # Google OAuth
      BETTER_AUTH_GOOGLE_CLIENT_ID: ${BETTER_AUTH_GOOGLE_CLIENT_ID}
      BETTER_AUTH_GOOGLE_CLIENT_SECRET: ${BETTER_AUTH_GOOGLE_CLIENT_SECRET}
      # Backend API
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api:8000}
      API_KEY: ${JOB_LAND_API_KEY}
      # UploadThing
      UPLOADTHING_TOKEN: ${UPLOADTHING_TOKEN}
      # Vercel AI SDK (for AI chat in onboarding)
      GOOGLE_GENERATIVE_AI_API_KEY: ${GOOGLE_GENERATIVE_AI_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      api:
        condition: service_started
    networks:
      - job-agent-network

  # Caddy - reverse proxy and HTTPS (Caddyfile in repo; no Caddy on host)
  caddy:
    image: caddy:2-alpine
    container_name: job-agent-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - API_DOMAIN=${API_DOMAIN:-localhost}
      - FRONTEND_DOMAIN=${FRONTEND_DOMAIN:-}
      - APEX_DOMAIN=${APEX_DOMAIN:-}
      - FLOWER_DOMAIN=${FLOWER_DOMAIN:-}
      - FLOWER_BASIC_AUTH_USER=${FLOWER_BASIC_AUTH_USER:-}
      - FLOWER_BASIC_AUTH_HASH=${FLOWER_BASIC_AUTH_HASH:-}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
    depends_on:
      api:
        condition: service_started
      frontend:
        condition: service_healthy
      flower:
        condition: service_started
    networks:
      - job-agent-network

volumes:
  postgres_data:
  redis_data:

networks:
  job-agent-network:
    driver: bridge